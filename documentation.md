# Документация системы мониторинга Telegram-каналов

## Содержание
1. [Общее описание](#общее-описание)
2. [Архитектура системы](#архитектура-системы)
3. [Компоненты системы](#компоненты-системы)
4. [Процессы и алгоритмы работы](#процессы-и-алгоритмы-работы)
5. [Настройка и запуск](#настройка-и-запуск)
6. [API и интеграция](#api-и-интеграция)
7. [Роли пользователей](#роли-пользователей)
8. [Обработка ошибок](#обработка-ошибок)

## Общее описание

Система мониторинга Telegram-каналов предназначена для автоматического отслеживания новых сообщений в указанных каналах, их анализа на соответствие ключевым словам и отправки уведомлений операторам и администраторам. Система состоит из серверной части (backend) на FastAPI и клиентской части в виде Telegram-бота на aiogram.

Основные возможности системы:
- Мониторинг неограниченного количества Telegram-каналов
- Динамическое распределение каналов между аккаунтами Telethon
- Фильтрация сообщений по ключевым словам
- Отправка уведомлений через Telegram-бота
- Управление каналами и ключевыми словами через административный интерфейс
- Формирование отчетов о работе системы
- Логирование всех действий и сообщений

## Архитектура системы

Система построена на микросервисной архитектуре и состоит из следующих компонентов:

1. **Backend (FastAPI)**
   - REST API для управления системой
   - Сервис мониторинга каналов (Telethon)
   - Сервис обработки сообщений
   - Сервис уведомлений
   - База данных PostgreSQL

2. **Telegram-бот (aiogram)**
   - Интерфейс для взаимодействия с пользователями
   - Отправка уведомлений
   - Обработка команд администраторов и операторов

3. **База данных (PostgreSQL 16)**
   - Хранение информации о каналах, постах, ключевых словах
   - Хранение данных аккаунтов Telethon
   - Логирование сообщений и действий пользователей

## Компоненты системы

### Backend

#### Модели данных
- **User** - пользователи системы (администраторы и операторы)
- **Channel** - отслеживаемые Telegram-каналы
- **Post** - посты из каналов
- **Keyword** - ключевые слова для фильтрации
- **TelethonAccount** - аккаунты Telethon для мониторинга
- **MessageLog** - логи сообщений и действий

#### Сервисы
- **channel_monitoring_service** - сервис мониторинга каналов
- **post_processing_service** - сервис обработки постов
- **notification_service** - сервис отправки уведомлений
- **user_service** - сервис управления пользователями
- **channel_service** - сервис управления каналами
- **keyword_service** - сервис управления ключевыми словами

### Telegram-бот

#### Обработчики команд
- Команды администратора
- Команды оператора
- Общие команды

#### Middleware
- **AuthMiddleware** - проверка пользователя в базе данных и определение его роли
- **LoggingMiddleware** - логирование сообщений пользователей

## Процессы и алгоритмы работы

### Мониторинг каналов

1. **Запуск мониторинга**
   - Периодический запуск с интервалом, указанным в настройках (CHANNEL_MONITORING_INTERVAL)
   - Запуск через API по требованию администратора

2. **Распределение каналов между аккаунтами**
   - Получение списка активных каналов из базы данных
   - Получение списка доступных аккаунтов Telethon
   - Равномерное распределение каналов между аккаунтами
   - Ограничение количества параллельных потоков (MAX_MONITORING_THREADS)

3. **Получение новых сообщений**
   - Подключение к Telegram через Telethon
   - Получение сообщений из канала, начиная с последнего обработанного (last_parsed_message_id)
   - Сохранение новых сообщений в базе данных

4. **Обработка ошибок**
   - При сбое аккаунта Telethon - перераспределение его каналов на другие аккаунты
   - Отправка уведомлений администраторам о сбоях
   - Автоматический перезапуск мониторинга при ошибках

### Обработка сообщений

1. **Фильтрация по ключевым словам**
   - Проверка текста сообщения на наличие ключевых слов
   - Определение приоритета сообщения

2. **Отправка уведомлений**
   - Формирование текста уведомления
   - Отправка уведомления операторам через Telegram-бота
   - Логирование отправленных уведомлений

3. **Обработка действий оператора**
   - Принятие или отклонение сообщения
   - Удаление дублирующих уведомлений у других операторов
   - Логирование действий оператора

### Аутентификация и авторизация

1. **Проверка пользователя**
   - Проверка наличия пользователя в базе данных по Telegram ID
   - Создание нового пользователя, если он не найден
   - Определение роли пользователя (admin/operator)

2. **Разграничение доступа**
   - Проверка прав доступа к командам и функциям
   - Ограничение доступа к административным функциям

## Настройка и запуск

### Переменные окружения (.env)

```
# Настройки базы данных
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=telegram_monitoring

# Настройки API
DEBUG=true
HOST=0.0.0.0
PORT=8000

# Настройки Telegram
TELEGRAM_BOT_TOKEN=your_bot_token_here
ADMIN_IDS=123456789,987654321
```

### Запуск системы

1. **Запуск базы данных**
   ```
   docker-compose up -d postgres
   ```

2. **Применение миграций**
   ```
   alembic upgrade head
   ```

3. **Запуск backend**
   ```
   python -m backend.main
   ```

4. **Запуск Telegram-бота**
   ```
   python -m bot.bot
   ```

## API и интеграция

### Основные эндпоинты API

- **GET /api/channels** - получение списка каналов
- **POST /api/channels** - добавление нового канала
- **GET /api/channels/{id}** - получение информации о канале
- **PUT /api/channels/{id}** - обновление информации о канале
- **DELETE /api/channels/{id}** - удаление канала

- **GET /api/keywords** - получение списка ключевых слов
- **POST /api/keywords** - добавление нового ключевого слова
- **DELETE /api/keywords/{id}** - удаление ключевого слова

- **GET /api/posts** - получение списка постов
- **GET /api/posts/{id}** - получение информации о посте

- **GET /api/telethon-accounts** - получение списка аккаунтов Telethon
- **POST /api/telethon-accounts** - добавление нового аккаунта Telethon
- **DELETE /api/telethon-accounts/{id}** - удаление аккаунта Telethon

- **POST /api/monitoring/start** - запуск мониторинга каналов
- **POST /api/monitoring/stop** - остановка мониторинга каналов

## Роли пользователей

### Администратор

Права и возможности:
- Управление каналами (добавление, удаление, редактирование)
- Управление ключевыми словами
- Управление аккаунтами Telethon
- Управление пользователями (назначение ролей)
- Просмотр отчетов и логов
- Запуск и остановка мониторинга
- Получение уведомлений о сбоях системы

### Оператор

Права и возможности:
- Просмотр списка каналов
- Предложение новых каналов для мониторинга
- Предложение новых ключевых слов
- Обработка уведомлений о новых сообщениях
- Просмотр истории обработанных сообщений

## Обработка ошибок

### Система уведомлений о сбоях

1. **Уведомления о сбоях мониторинга**
   - Отправка уведомлений администраторам через Telegram-бота
   - Логирование ошибок в базе данных
   - Автоматический перезапуск мониторинга

2. **Уведомления о сбоях аккаунтов Telethon**
   - Отправка уведомлений администраторам
   - Автоматическое перераспределение каналов на другие аккаунты
   - Отметка аккаунта как неактивного в базе данных

3. **Обработка ошибок API**
   - Стандартизированные ответы с кодами ошибок
   - Логирование ошибок
   - Возврат информативных сообщений об ошибках

---

© 2025 Система мониторинга Telegram-каналов
