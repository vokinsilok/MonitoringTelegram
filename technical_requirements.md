# Техническое задание: Система мониторинга Telegram-каналов

## 1. Архитектура системы

### 1.1. Компоненты системы
- **Клиентская часть**: Telegram-бот на базе фреймворка aiogram
- **Серверная часть**: FastAPI (последняя версия) с асинхронным движком SQLAlchemy 2+
- **Мониторинг каналов**: Telethon для парсинга Telegram-каналов
- **База данных**: PostgreSQL 16

## 2. Роли пользователей

### 2.1. Администратор
- Управление списком каналов для мониторинга
- Управление операторами (добавление, удаление, настройка прав)
- Настройка ключевых слов и фраз для мониторинга
- Доступ ко всем функциям оператора
- Управление клиентами Telethon

### 2.2. Оператор
- Просмотр и обработка постов из мониторинга
- Предложение новых каналов для мониторинга (требует одобрения администратора)
- Предложение новых ключевых слов и фраз (требует одобрения администратора)
- Доступ к отчетам по обработанным постам

## 3. Функциональные требования

### 3.1. Мониторинг каналов
- Система должна поддерживать до 10 параллельных воркеров Telethon
- Каждый воркер обслуживает один клиент Telethon
- Количество воркеров определяется количеством клиентов в базе данных
- При проблемах с аутентификацией клиента все администраторы получают уведомление

### 3.2. Управление каналами и ключевыми словами
- Администратор может добавлять каналы напрямую
- Оператор может предлагать каналы для добавления
- Администратор получает уведомление о предложении с кнопками:
  - "Посмотреть подробно"
  - "Подтвердить"
  - "Отклонить"
- Результат рассмотрения предложения отправляется оператору
- **Важно**: Если один из администраторов принял решение по предложению, аналогичные уведомления у других администраторов должны автоматически удаляться

### 3.3. Обработка постов
- Посты, соответствующие критериям мониторинга, рассылаются операторам
- Каждое сообщение с постом содержит кнопки:
  - "Перейти к первоисточнику" (открывает оригинальный пост)
  - "Показать полностью" (отображает полный пост с медиафайлами, источником, датой публикации)
  - "Обработано" (установка статуса)
  - "Отложено" (установка статуса)
- После установки статуса оператор должен добавить комментарий
- **Важно**: Если пост обработан одним оператором, аналогичные сообщения у других операторов должны автоматически удаляться

### 3.4. Отчеты
- Администраторы и операторы могут получать отчеты:
  - За определенный день
  - За указанный период времени
- Формат отчета:
  ```
  Отчет за период [дата_начала] - [дата_окончания]:
  1. Комментарий: [текст]
     Источник: [название_канала]
     Дата публикации: [дата]
     Статус: [обработано/отложено]
     Дата обработки: [дата]
     Оператор: [имя_оператора]
     Ссылка: [url]
  ```
- Отчеты сортируются по дате публикации

### 3.5. Логирование и отчетность
- **Все отправленные сообщения** (уведомления, посты) сохраняются в базе данных с информацией:
  - Кому отправлено
  - Что отправлено
  - Когда отправлено
- **Операторы** могут получать отчеты по всем отправленным им сообщениям
- Логирование должно обеспечивать полную прозрачность всех коммуникаций в системе

## 4. Технические требования

### 4.1. База данных
- PostgreSQL 16
- Асинхронное взаимодействие через SQLAlchemy 2+
- Хранение информации о:
  - Пользователях (администраторы, операторы)
  - Каналах для мониторинга
  - Ключевых словах и фразах
  - Постах и их статусах
  - Отправленных сообщениях (включая информацию о получателе, содержании и времени отправки)
  - Клиентах Telethon

### 4.2. Бэкенд
- FastAPI (последняя версия)
- Асинхронная обработка запросов
- Фоновые задачи для мониторинга каналов
- Система воркеров для Telethon-клиентов
- Механизм синхронизации для удаления дублирующих уведомлений у администраторов и операторов

### 4.3. Telegram-бот
- Фреймворк aiogram
- Интерфейс с кнопками для всех основных функций
- Разделение логики для разных ролей пользователей
- Система уведомлений с возможностью автоматического удаления дублирующих сообщений
